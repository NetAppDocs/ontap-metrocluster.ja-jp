---
permalink: install-ip/concept_considerations_layer_2.html 
sidebar: sidebar 
keywords: differences, eight-node, four-node, fabric-attached, stretch, metrocluster ip, storage, bridges, fc-to-sas, atto, fibrebridge, SAS, local HA, auso, automatic unplanned switchover, array luns, mediator, tiebreaker 
summary: ONTAP 9.6 以降では、サポート対象の Cisco スイッチを使用した MetroCluster IP 構成で、専用の MetroCluster ISL を使用する代わりに、既存のネットワークを ISL で共有することができます。 
---
= プライベートレイヤ 2 ネットワークの共有に関する考慮事項
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAP 9.6 以降では、サポート対象の Cisco スイッチを使用した MetroCluster IP 構成で、専用の MetroCluster ISL を使用する代わりに、既存のネットワークを ISL で共有することができます。それよりも前のバージョンの ONTAP では専用の ISL が必要

MetroCluster IP スイッチは MetroCluster 構成専用であり、共有することはできません。したがって、一連の MetroCluster IP スイッチで接続できる MetroCluster 設定は 1 つだけです。共有スイッチに接続できるのは、 MetroCluster IP スイッチの MetroCluster ISL ポートだけです。


CAUTION: 共有ネットワークを使用する場合は、共有ネットワークの MetroCluster ネットワーク要件を満たす必要があります。



== ISL の要件

の要件を満たしている必要があります。

* link:../install-ip/concept_considerations_isls.html#basic-metrocluster-isl-requirements["MetroCluster ISL の基本要件"]
* link:../install-ip/concept_considerations_isls.html#isl-requirements-in-shared-layer-2-networks["共有レイヤ 2 ネットワークにおける ISL の要件"]




== 中間スイッチに必要な設定

共有ネットワークで ISL トラフィックを共有する場合、 MetroCluster サイト間のすべてのパスにおいて MetroCluster トラフィック（ RDMA とストレージ）が必要なサービスレベルを満たすように、お客様提供の中間スイッチを設定する必要があります。

次の例は、 Cisco Nexus 3000 スイッチと IP Broadcom スイッチを示しています。スイッチのベンダーやモデルに応じて、使用する中間スイッチで同等の設定を確認する必要があります。



=== Cisco Nexus スイッチ

次の図は、 Cisco スイッチを使用する場合の共有ネットワークの必須設定の概要を示しています。

image::../media/switch_traffic_with_cisco_switches.png[Cisco スイッチでトラフィックを切り替えます]

この例では、 MetroCluster トラフィックに対して次のポリシーとマップが作成されます。

* MetroClusterIP_Ingress ポリシー。 MetroCluster IP スイッチに接続する中間スイッチのポートに適用されます。
+
MetroClusterIP_Ingress ポリシーは、受信するタグ付きトラフィックを中間スイッチの適切なキューにマッピングします。タグ付けは ISL ではなくノードポートで行われます。ISL で同じポートを使用している MetroCluster 以外のトラフィックは、デフォルトキューに残ります。

* MetroClusterIP_Egress ポリシー。中間スイッチ間の ISL に接続する中間スイッチのポートに適用されます


MetroCluster IP スイッチ間のパスに沿って、一致する QoS アクセスマップ、クラスマップ、およびポリシーマップを使用して中間スイッチを設定する必要があります。中間スイッチは、 RDMA トラフィックを COS5 にマッピングし、ストレージトラフィックを COS4 にマッピングします。

次の例は、お客様が用意した Cisco Nexus 3000 スイッチの設定を示しています。Cisco スイッチを使用している場合は、この例を使用してパスに沿ってスイッチを設定できます。Cisco スイッチを使用していない場合は、使用している中間スイッチに対し、同等の設定を確認して適用する必要があります。

次に、クラスマップ定義の例を示します。


NOTE: この例は、 Cisco MetroCluster IP スイッチを使用する構成のものです。この例は、 MetroCluster IP スイッチに接続していない MetroCluster トラフィックを伝送するスイッチのスイッチタイプに関係なく使用できます。

[listing]
----
class-map type qos match-all rdma
   match cos 5
class-map type qos match-all storage
   match cos 4
----
次に、ポリシーマップ定義の例を示します。

[listing]
----
policy-map type qos MetroClusterIP_Ingress
   class rdma
      set dscp 40
      set cos 5
      set qos-group 5
   class storage
      set dscp 32
      set cos 4
      set qos-group 4
policy-map type queuing MetroClusterIP_Egress
   class type queuing c-out-8q-q7
      priority level 1
   class type queuing c-out-8q-q6
      priority level 2
   class type queuing c-out-8q-q5
      priority level 3
      random-detect threshold burst-optimized ecn
   class type queuing c-out-8q-q4
      priority level 4
      random-detect threshold burst-optimized ecn
   class type queuing c-out-8q-q3
      priority level 5
   class type queuing c-out-8q-q2
      priority level 6
   class type queuing c-out-8q-q1
      priority level 7
   class type queuing c-out-8q-q-default
      bandwidth remaining percent 100
      random-detect threshold burst-optimized ecn
----


=== MetroCluster IP Broadcom スイッチ

次の図は、外部スイッチが IP Broadcom スイッチの場合に共有ネットワークに必要な設定の概要を示しています。

image::../media/switch_traffic_with_broadcom_switches.png[Broadcom スイッチでトラフィックを切り替えます]

MetroCluster IP Broadcom スイッチを使用する構成では、追加の設定が必要です。

* エクステリアスイッチの場合、アクセスマップとクラスマップを設定して、カスタマーネットワークへの入力トラフィックを分類する必要があります。
+

NOTE: MetroCluster IP スイッチを使用する構成では必要ありません。

+
次の例は、 MetroCluster IP Broadcom スイッチ間で ISL を接続する 1 番目と最後のお客様のスイッチでアクセスマップとクラスマップを設定する方法を示しています。



[listing]
----
ip access-list storage
  10 permit tcp any eq 65200 any
  20 permit tcp any any eq 65200
ip access-list rdma
  10 permit tcp any eq 10006 any
  20 permit tcp any any eq 10006

class-map type qos match-all storage
  match access-group name storage
class-map type qos match-all rdma
  match access-group name rdma
----
* 最初のカスタマースイッチの ISL スイッチポートに入力ポリシーを割り当てる必要があります。
+
次に、クラスマップ定義の例を示します。

+

NOTE: この例は、 Cisco MetroCluster IP スイッチを使用する構成のものです。この例は、 MetroCluster IP スイッチに接続していない MetroCluster トラフィックを伝送するスイッチのスイッチタイプに関係なく使用できます。

+
[listing]
----
class-map type qos match-all rdma
   match cos 5
class-map type qos match-all storage
   match cos 4
----
+
次に、ポリシーマップ定義の例を示します。

+
[listing]
----
policy-map type qos MetroClusterIP_Ingress
   class rdma
      set dscp 40
      set cos 5
      set qos-group 5
   class storage
      set dscp 32
      set cos 4
      set qos-group 4
policy-map type queuing MetroClusterIP_Egress
   class type queuing c-out-8q-q7
      priority level 1
   class type queuing c-out-8q-q6
      priority level 2
   class type queuing c-out-8q-q5
      priority level 3
      random-detect threshold burst-optimized ecn
   class type queuing c-out-8q-q4
      priority level 4
      random-detect threshold burst-optimized ecn
   class type queuing c-out-8q-q3
      priority level 5
   class type queuing c-out-8q-q2
      priority level 6
   class type queuing c-out-8q-q1
      priority level 7
   class type queuing c-out-8q-q-default
      bandwidth remaining percent 100
      random-detect threshold burst-optimized ecn
----




=== お客様の中間スイッチ

* 中間顧客のスイッチの場合、出力ポリシーを ISL スイッチポートに割り当てる必要があります。
* MetroCluster トラフィックを伝送するパスにあるその他すべての内部スイッチについては、 _Cisco Nexus 3000 switchs_. のクラスマップおよびポリシーマップの例を参照してください。




== MetroCluster ネットワークトポロジの例

ONTAP 9.6 以降では、一部の共有 ISL ネットワーク構成が MetroCluster IP 構成でサポートされます。



=== 直接リンクを使用した共有ネットワーク構成

このトポロジでは、 2 つのサイトが直接リンクで接続されます。直接リンクは、波長分割多重機器（ xWDM ）またはスイッチとの間に設定できます。ISL の容量は MetroCluster トラフィック専用ではなく、他のトラフィックと共有されます。

ISL の容量が最小要件を満たしている必要があります。xWDM デバイスとスイッチのどちらを使用するかによって、適用できるネットワーク構成の組み合わせが変わります。

image::../media/mcc_ip_networking_with_shared_isls.gif[共有 ISL を使用する MCC IP ネットワーク]



=== 中間ネットワークを使用する共有インフラ

このトポロジでは、 MetroCluster IP コアスイッチのトラフィックとホストトラフィックが、ネットアップが提供したものでないネットワークを経由します。ネットワークインフラとリンク（リースされた直接リンクを含む）は、 MetroCluster 構成の外部にあります。ネットワークは一連の xWDM とスイッチで構成できますが、直接 ISL を使用した共有構成とは異なり、サイト間のリンクは直接接続ではありません。サイト間のインフラによっては、ネットワーク構成を任意に組み合わせて設定できます。中間インフラストラクチャは「クラウド」として表されます（サイト間に複数のデバイスを配置できます）が、お客様の管理下にあります。この中間インフラの処理容量は、 MetroCluster トラフィック専用ではなく、他のトラフィックと共有されます。

VLAN およびネットワーク xWDM またはスイッチの設定が、最小要件を満たしている必要があります。

image::../media/mcc_ip_networking_with_intermediate_private_networks.gif[中間プライベートネットワークを使用する MCC IP ネットワーク]



=== 2 つの MetroCluster 構成が中間ネットワークを共有します

このトポロジでは、 2 つの異なる MetroCluster 構成が同じ中間ネットワークを共有しています。この例では、 MetroCluster 1 の switch_A_1 と MetroCluster 2 の switch_A_1 が同じ中間スイッチに接続されています。

この例はわかりやすくするために簡略化したものです。

image::../media/mcc_ip_two_mccs_sharing_the_same_shared_network_sx.gif[同じ共有ネットワーク SX を共有する MCC IP 2 MCCS]



=== 2 つの MetroCluster 構成。 1 つは中間ネットワークに直接接続します

このトポロジは ONTAP 9.7 以降でサポートされています。2 つの MetroCluster 構成は同じ中間ネットワークを共有し、 1 つの MetroCluster 構成のノードは中間スイッチに直接接続されます。

MetroCluster ONE は、ネットアップの検証済みスイッチ、 ONTAP 9.6 、および共有トポロジを使用する MetroCluster 構成です。MetroCluster 2 は、ネットアップ準拠のスイッチと ONTAP 9.7 を使用した MetroCluster 構成です。


NOTE: 中間スイッチはネットアップの仕様に準拠している必要があります。

この例はわかりやすくするために簡略化したものです。

image::../media/mcc_ip_unsupported_two_mccs_direct_to_shared_switches.png[MCC IP では、 2 台の MCCS を共有スイッチに直接接続することはできません]
